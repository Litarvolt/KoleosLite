@page "/register"
@inject HttpClient Http
@inject NavigationManager Nav
@inject Microsoft.AspNetCore.Identity.UserManager<KoleosDemo.Entidades.ApplicationUser> UserManager

<div class="d-flex justify-content-center align-items-center" style="height:70vh">
 <div class="card p-4 shadow-sm" style="width:420px">
 <h4 class="text-center mb-3">Crear cuenta</h4>
 <div class="mb-3">
 <label class="form-label">Usuario</label>
 <input class="form-control" @bind="form.NombreUsuario" />
 </div>
 <div class="mb-3">
 <label class="form-label">Correo</label>
 <input class="form-control" @bind="form.Correo" />
 </div>
 <div class="mb-3">
 <label class="form-label">Contraseña</label>
 <input type="password" class="form-control" @bind="password" />
 </div>
 <div class="mb-3">
 <label class="form-label">Confirmar contraseña</label>
 <input type="password" class="form-control" @bind="confirm" />
 </div>
 @if (!string.IsNullOrEmpty(msg)) { <div class="alert alert-danger">@msg</div> }
 <div class="d-grid">
 <button class="btn btn-primary" @onclick="Create">Crear cuenta</button>
 </div>
 <div class="text-center mt-3 small text-muted">Ya tienes cuenta? <a href="/login">Entrar</a></div>
 </div>
</div>

@code{
 private RegisterForm form = new();
 private string password = "";
 private string confirm = "";
 private string msg = "";

 private class RegisterForm {
 public string NombreUsuario { get; set; } = string.Empty;
 public string Correo { get; set; } = string.Empty;
 }

 private async Task Create()
 {
 msg = string.Empty;
 if (string.IsNullOrWhiteSpace(form.NombreUsuario) || string.IsNullOrWhiteSpace(password)) { msg = "Usuario y contraseña requeridos"; return; }
 if (password != confirm) { msg = "Las contraseñas no coinciden"; return; }
 try
 {
 if (UserManager != null)
 {
 var user = new KoleosDemo.Entidades.ApplicationUser { UserName = form.NombreUsuario, Email = form.Correo };
 var result = await UserManager.CreateAsync(user, password);
 if (result.Succeeded)
 {
 Nav.NavigateTo("/login");
 return;
 }
 else
 {
 msg = string.Join("; ", result.Errors.Select(e => e.Description));
 return;
 }
 }
 else
 {
 var model = new KoleosDemo.Controllers.UsuariosController.RegisterModel(form.NombreUsuario, form.Correo, password, null);
 var res = await Http.PostAsJsonAsync("/api/usuarios/register", model);
 if (res.IsSuccessStatusCode)
 {
 Nav.NavigateTo("/login");
 return;
 }
 else
 {
 var text = await res.Content.ReadAsStringAsync();
 msg = text;
 }
 }
 }
 catch
 {
 msg = "Error al contactar al servidor";
 }
 }
}